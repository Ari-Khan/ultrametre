<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Car Live Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg1: #071022; --bg2: #07182a; --accent1: #5eead4; --accent2: #60a5fa; }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, var(--bg1), var(--bg2)); color: #e8eef7; padding: 20px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; max-width: 800px; }
        .card { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); }
        .big { font-size: 32px; font-weight: 800; }
        button { padding: 10px 20px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; margin: 5px; }
        .btn-primary { background: linear-gradient(90deg, #60a5fa, #5eead4); color: #071025; }
        .btn-danger { background: #fb7185; color: white; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .running { background: #34d399; }
        .stopped { background: #ef4444; }
        /* loading (yellow) state */
        .loading { background: linear-gradient(90deg, #f59e0b, #fbbf24); box-shadow: 0 8px 20px rgba(251,191,36,0.18); animation: pulse 1s ease-in-out infinite; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1 } 50% { transform: scale(1.25); opacity: 0.85 } 100% { transform: scale(1); opacity: 1 } }
        #raw { font-family: monospace; font-size: 12px; color: #9fb0c9; overflow: hidden; }
    </style>
</head>
<body>
    <h2>ðŸš— Car Live Dashboard</h2>
    <div class="grid">
        <div class="card"><div class="label">Status</div><div id="state" class="big">OFFLINE</div></div>
        <div class="card"><div class="label">Distance</div><div id="dist" class="big">0 cm</div></div>
        <div class="card" style="grid-column: span 2;"><div class="label">Raw Serial</div><div id="raw">Waiting for data...</div></div>
    </div>

    <div style="margin-top: 20px;">
        <button id="startBtn" class="btn-primary" onclick="controlBridge('start')">Start Bridge</button>
        <button id="stopBtn" class="btn-danger" onclick="controlBridge('stop')" disabled>Stop Bridge</button>
        <p id="bridgeStatus"><span class="status-dot stopped"></span> Bridge Stopped</p>
    </div>

    <div style="margin-top: 20px;">
        <input id="amt" type="number" step="0.001" value="0.01" style="padding: 8px; border-radius: 5px;">
        <button class="btn-primary" onclick="sendSol()">ðŸ’¸ Send SOL & Launch</button>
        <p id="txResult"></p>
    </div>

    <script>
        const events = new EventSource('/bridge/events');
        
        events.addEventListener('serial', (e) => {
            const data = JSON.parse(e.data);
            document.getElementById('raw').innerText = data.text;
            const parts = data.text.split(',');
            if(parts.length >= 5) {
                document.getElementById('dist').innerText = parts[4] + ' cm';
                document.getElementById('state').innerText = 'MOVING';
            }
        });

        events.addEventListener('status', (e) => {
            const data = JSON.parse(e.data);
            updateUI(data.running);
        });

        function setBridgeLoading(isLoading) {
            const bridgeStatus = document.getElementById('bridgeStatus');
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            if (isLoading) {
                bridgeStatus.innerHTML = '<span class="status-dot loading"></span> Bridge starting...';
                startBtn.disabled = true;
                stopBtn.disabled = true;
            } else {
                // fall back to stopped visual until we get status update
                bridgeStatus.innerHTML = '<span class="status-dot stopped"></span> Bridge stopped';
                startBtn.disabled = false;
                stopBtn.disabled = true;
            }
        }

        async function controlBridge(action) {
            if (action === 'start') setBridgeLoading(true);
            const res = await fetch(`/bridge/${action}`, { method: 'POST' });
            const data = await res.json();
            if (!data.ok) {
                if (action === 'start') setBridgeLoading(false);
                return alert('Error: ' + data.error);
            }

            // refresh status without full reload
            try {
                const s = await fetch('/bridge/status');
                const status = await s.json();
                updateUI(status.running);
            } catch (e) {
                document.getElementById('bridgeStatus').innerText = 'Bridge: unreachable';
            }
        }

        async function sendSol() {
            const btn = event.target;
            const resEl = document.getElementById('txResult');
            btn.disabled = true;
            resEl.innerText = "Processing Transaction...";
            
            try {
                const res = await fetch('/bridge/send', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ amount: document.getElementById('amt').value })
                });
                const data = await res.json();
                resEl.innerText = data.ok ? "âœ“ Sent: " + data.signature.slice(0,10) + "..." : "Error: " + data.error;
            } catch (e) {
                resEl.innerText = "Failed to connect to server.";
            }
            btn.disabled = false;
        }

        function updateUI(running) {
            document.getElementById('startBtn').disabled = running;
            document.getElementById('stopBtn').disabled = !running;
            document.getElementById('bridgeStatus').innerHTML = running ? 
                '<span class="status-dot running"></span> Bridge Running (COM5)' : 
                '<span class="status-dot stopped"></span> Bridge Stopped';
        }

        // Initial Status Check
        fetch('/bridge/status').then(r => r.json()).then(d => updateUI(d.running));
    </script>
</body>
</html>